---
import PageLayout from '~/layouts/PageLayout.astro';
const service = Astro.url.searchParams.get('service') || 'web-dev';
const serviceMap = {
  'web-dev': 'Web Development',
  'ai': 'AI Integration',
  'wp-plugin': 'WordPress Plugin',
  'hosting': 'Hosting Setup'
};
---
<PageLayout>
  <section class="max-w-xl mx-auto py-16">
    <h1 class="text-3xl font-bold mb-6">Payment</h1>
    <div class="mb-4">
      <strong>Service:</strong> {serviceMap[service] || 'Web Development'}
    </div>
    <form id="payment-form" class="space-y-4">
      <input type="hidden" name="service" value={service} />
      <label class="block mb-2">
        <span class="text-gray-700">Coupon Code (optional):</span>
        <input type="text" name="coupon" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50" />
      </label>
      <button type="submit" class="w-full bg-primary-600 text-white px-6 py-2 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
        Pay Now
      </button>
    </form>
  </section>
</PageLayout>

<script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
<script>
  const form = document.getElementById('payment-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    try {
      const response = await fetch('/api/pay', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      if (response.ok) {
        const cashfree = new window.Cashfree();
        const paymentConfig = {
          paymentSessionId: data.paymentSessionId,
          orderToken: data.orderToken,
          orderAmount: data.amount / 100,
          orderCurrency: data.currency,
          orderNote: 'Service Payment',
          customerName: '',
          customerEmail: '',
          customerPhone: '',
          returnUrl: 'https://jitenderkumar.in/dashboard',
          notifyUrl: 'https://jitenderkumar.in/api/cashfree-webhook'
        };

        cashfree.init(paymentConfig);
        await cashfree.redirect();
      } else {
        alert(data.error || 'Payment initialization failed');
      }
    } catch (error) {
      console.error('Payment error:', error);
      alert('Failed to process payment. Please try again.');
    }
  });
</script>
</script>
